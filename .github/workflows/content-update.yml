name: Content Update Reminder

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì •ì˜¤ (KST) = ì›”ìš”ì¼ ìƒˆë²½ 3ì‹œ (UTC) â€” seasonal-content(00:00 UTC) ì´í›„ ì‹¤í–‰
    - cron: '0 3 * * 1'
    # ë§¤ì›” 1ì¼ ì •ì˜¤ (KST) = 1ì¼ ìƒˆë²½ 3ì‹œ (UTC)
    - cron: '0 3 1 * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Check type'
        required: true
        default: 'health'
        type: choice
        options:
          - health
          - seasonal

permissions:
  contents: read
  actions: write
  issues: write

jobs:
  content-health-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Run content health check
        run: npx tsx scripts/content-health-check.ts

      - name: Validate content integrity
        run: npx tsx scripts/validate-content.ts

      - name: Check seasonal content
        run: npx tsx scripts/add-seasonal-fortunes.ts check

      - name: Check blog freshness
        run: |
          echo "Checking blog post freshness..."
          RECENT=$(git log --since="14 days ago" --name-only --pretty=format: -- "src/data/blog-posts.ts" | grep -c "blog-posts.ts" || echo "0")
          echo "Blog updates in last 14 days: $RECENT"
          if [ "$RECENT" -lt 1 ]; then
            echo "::warning::ë¸”ë¡œê·¸ê°€ 14ì¼ ì´ìƒ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "BLOG_STALE=true" >> $GITHUB_ENV
          else
            echo "Blog freshness OK"
            echo "BLOG_STALE=false" >> $GITHUB_ENV
          fi

      - name: Trigger daily-blog if stale
        if: env.BLOG_STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'daily-blog-post.yml',
              ref: 'main'
            });
            console.log('Triggered daily-blog-post workflow due to stale content');

      - name: Check fortune freshness
        run: |
          echo "Checking fortune freshness..."
          RECENT=$(git log --since="14 days ago" --name-only --pretty=format: -- "src/data/fortunes/*.ts" | grep -c ".ts" || echo "0")
          echo "Fortune file changes in last 14 days: $RECENT"
          if [ "$RECENT" -lt 1 ]; then
            echo "::warning::ìš´ì„¸ ë©”ì‹œì§€ê°€ 14ì¼ ì´ìƒ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "FORTUNE_STALE=true" >> $GITHUB_ENV
          else
            echo "Fortune freshness OK"
            echo "FORTUNE_STALE=false" >> $GITHUB_ENV
          fi

      - name: Trigger weekly-fortune if stale
        if: env.FORTUNE_STALE == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'weekly-fortune-update.yml',
              ref: 'main'
            });
            console.log('Triggered weekly-fortune-update workflow due to stale content');

      - name: Create issue if content needs update
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const month = now.getMonth() + 1;
            const day = now.getDate();

            // Monthly blog reminder (1st of each month)
            if (day <= 7) {
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'content-update',
                state: 'open',
              });

              const monthlyExists = existingIssues.data.some(
                (i) => i.title.includes(`${month}ì›” ì½˜í…ì¸ `)
              );

              if (!monthlyExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ğŸ“ ${month}ì›” ì½˜í…ì¸  ì—…ë°ì´íŠ¸ ë¦¬ë§ˆì¸ë”`,
                  body: `## ${month}ì›” ì½˜í…ì¸  ì—…ë°ì´íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸\n\n` +
                    `### ë¸”ë¡œê·¸\n` +
                    `- [ ] ìƒˆ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ 1-2ê°œ ì‘ì„± (800ì ì´ìƒ)\n` +
                    `- [ ] ê¸°ì¡´ í¬ìŠ¤íŠ¸ ë‚´ìš© ê²€í†  ë° ì—…ë°ì´íŠ¸\n\n` +
                    `### ìš´ì„¸ ë©”ì‹œì§€\n` +
                    `- [ ] ìƒˆ ìš´ì„¸ ë©”ì‹œì§€ 10-20ê°œ ì¶”ê°€ ê²€í† \n` +
                    `- [ ] ê¸°ì¡´ ë©”ì‹œì§€ í’ˆì§ˆ ì ê²€\n\n` +
                    `### ì‹œì¦Œ ì²´í¬\n` +
                    `- [ ] \`npx tsx scripts/add-seasonal-fortunes.ts check\` ì‹¤í–‰\n` +
                    `- [ ] ì‹œì¦Œë³„ íŠ¹ë³„ ì½˜í…ì¸  í•„ìš” ì—¬ë¶€ í™•ì¸\n\n` +
                    `### SEO\n` +
                    `- [ ] Google Search Console ìƒ‰ì¸ ìƒíƒœ í™•ì¸\n` +
                    `- [ ] ë„¤ì´ë²„ ì„œì¹˜ì–´ë“œë°”ì´ì € ìƒíƒœ í™•ì¸\n` +
                    `- [ ] ê²€ìƒ‰ í‚¤ì›Œë“œ ìˆœìœ„ ëª¨ë‹ˆí„°ë§\n`,
                  labels: ['content-update'],
                });
              }
            }

            // Seasonal reminders
            const seasonalMonths = {
              1: 'ì‹ ë…„ íŠ¹ë³„ ìš´ì„¸',
              2: 'ë°œë Œíƒ€ì¸ ì‚¬ë‘ìš´',
              10: 'ìˆ˜ëŠ¥ ì‹œì¦Œ í•™ì—…ìš´',
              12: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ í™€ë¦¬ë°ì´ ìš´ì„¸',
            };

            if (month in seasonalMonths && day <= 7) {
              const label = seasonalMonths[month];
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'seasonal',
                state: 'open',
              });

              const seasonalExists = existingIssues.data.some(
                (i) => i.title.includes(label)
              );

              if (!seasonalExists) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ğŸ‰ ${label} ì½˜í…ì¸  ì¤€ë¹„`,
                  body: `## ${label}\n\n` +
                    `ì´ë²ˆ ë‹¬ì€ ì‹œì¦Œ ì´ë²¤íŠ¸ê°€ ì˜ˆì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\n` +
                    `### í•  ì¼\n` +
                    `- [ ] ì‹œì¦Œ ìš´ì„¸ ë©”ì‹œì§€ 15-20ê°œ ì¶”ê°€\n` +
                    `- [ ] ì‹œì¦Œ ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸ 1ê°œ ì‘ì„±\n` +
                    `- [ ] ë©”ì¸ í˜ì´ì§€ ì‹œì¦Œ í…Œë§ˆ ì ìš© (ì„ íƒ)\n` +
                    `- [ ] SNS í™ë³´ ì½˜í…ì¸  ì¤€ë¹„\n\n` +
                    `\`npx tsx scripts/add-seasonal-fortunes.ts check\` ë¡œ ìƒì„¸ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.`,
                  labels: ['seasonal', 'content-update'],
                });
              }
            }

      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Workflow Failure] Content Update - ${new Date().toISOString().split('T')[0]}`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure',
            });
            const existing = issues.find(i => i.title.includes('Content Update'));
            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `Workflow run failed: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                labels: ['workflow-failure'],
              });
            }

      - name: Auto-close failure issues on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure',
            });
            for (const issue of issues) {
              if (issue.title.includes('Content Update')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed',
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `âœ… ì½˜í…ì¸  í—¬ìŠ¤ì²´í¬ í†µê³¼.\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                });
              }
            }
