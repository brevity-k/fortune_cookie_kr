name: Weekly Fortune Message Generator

on:
  schedule:
    # ë§¤ì£¼ ì¼ìš”ì¼ ì˜¤í›„ 9ì‹œ (UTC) = ì›”ìš”ì¼ ì˜¤ì „ 6ì‹œ (KST)
    - cron: '0 21 * * 0'
  workflow_dispatch:
    inputs:
      category:
        description: 'Specific category (love/career/health/study/general/relationship). Leave empty for next in rotation.'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (no file changes)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-fortunes:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Generate fortune messages
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="--dry-run"
          fi
          if [ -n "${{ github.event.inputs.category }}" ]; then
            ARGS="$ARGS --category ${{ github.event.inputs.category }}"
          fi
          npx tsx scripts/generate-fortunes.ts $ARGS

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'content: add weekly fortune messages'
          title: 'ğŸ¥  Weekly Fortune Messages'
          body: |
            ## ìë™ ìƒì„± ìš´ì„¸ ë©”ì‹œì§€

            ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
            ë§¤ì£¼ 5ê°œì˜ ìƒˆë¡œìš´ ìš´ì„¸ ë©”ì‹œì§€ê°€ ì¹´í…Œê³ ë¦¬ë¥¼ ìˆœí™˜í•˜ë©° ì¶”ê°€ë©ë‹ˆë‹¤.

            ### ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ìš´ì„¸ ë©”ì‹œì§€ ë‚´ìš© ê²€í† 
            - [ ] í•œêµ­ì–´ ë§ì¶¤ë²•/ë¬¸ë²• í™•ì¸
            - [ ] rating ë¶„í¬ ì ì ˆì„± í™•ì¸
            - [ ] ê¸°ì¡´ ë©”ì‹œì§€ì™€ ì¤‘ë³µ ì—†ìŒ í™•ì¸
            - [ ] `npm run build` í†µê³¼ í™•ì¸

            > ìë™ ë¨¸ì§€ë¥¼ ì›í•˜ë©´ `auto-merge` ë¼ë²¨ì„ ì¶”ê°€í•˜ì„¸ìš”.
          branch: fortune/weekly-update
          labels: |
            fortune
            auto-generated
          delete-branch: true
