name: Site Health Check

on:
  schedule:
    # 6시간마다 실행
    - cron: '0 */6 * * *'
  workflow_dispatch:

permissions:
  issues: write

jobs:
  health-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check site health
        id: health
        run: |
          FAILED=""
          URLS=(
            "https://fortunecookie.ai.kr"
            "https://fortunecookie.ai.kr/fortune/love"
            "https://fortunecookie.ai.kr/blog"
            "https://fortunecookie.ai.kr/compatibility"
          )
          for url in "${URLS[@]}"; do
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" --max-time 15 "$url" || echo "000")
            echo "$url -> $STATUS"
            if [ "$STATUS" -lt 200 ] || [ "$STATUS" -ge 400 ]; then
              FAILED="$FAILED\n- $url (HTTP $STATUS)"
            fi
          done
          if [ -n "$FAILED" ]; then
            echo "failed_urls<<EOF" >> $GITHUB_OUTPUT
            echo -e "$FAILED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "healthy=false" >> $GITHUB_OUTPUT
          else
            echo "healthy=true" >> $GITHUB_OUTPUT
          fi

      - name: Create issue on failure
        if: steps.health.outputs.healthy == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'site-down',
            });
            if (issues.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Site Down] Health check failed - ${new Date().toISOString().split('T')[0]}`,
                body: `Site health check detected issues:\n${{ steps.health.outputs.failed_urls }}\n\nRun: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                labels: ['site-down'],
              });
            }

      - name: Auto-close issue on recovery
        if: steps.health.outputs.healthy == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'site-down',
            });
            for (const issue of issues) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed',
                state_reason: 'completed',
              });
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: 'Site has recovered. All health checks passing.',
              });
            }
