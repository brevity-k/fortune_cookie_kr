name: Daily Blog Post Generator

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 6ì‹œ (KST) = ì „ë‚  ì˜¤í›„ 9ì‹œ (UTC)
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      topic:
        description: 'Specific topic slug (leave empty for next in queue)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (no file changes)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - run: npm ci

      - name: Generate blog post
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="--dry-run"
          fi
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            ARGS="$ARGS --topic ${{ github.event.inputs.topic }}"
          fi
          npx tsx scripts/generate-blog-post.ts $ARGS

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'content: add daily blog post'
          title: 'ğŸ“ Daily Blog Post'
          body: |
            ## ìë™ ìƒì„± ë¸”ë¡œê·¸ í¬ìŠ¤íŠ¸

            ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

            ### ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] ì½˜í…ì¸  ë‚´ìš© ê²€í† 
            - [ ] ì‚¬ì‹¤ ê´€ê³„ í™•ì¸
            - [ ] ë§ì¶¤ë²•/ë¬¸ë²• í™•ì¸

            > ìë™ ë¨¸ì§€ë¥¼ ì›í•˜ë©´ `auto-merge` ë¼ë²¨ì„ ì¶”ê°€í•˜ì„¸ìš”.
          branch: blog/daily-post
          labels: |
            blog
            auto-generated
          delete-branch: true
