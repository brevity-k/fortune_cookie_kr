name: Daily Blog Post Generator

on:
  schedule:
    # 매일 오전 6시 (KST) = 전날 오후 9시 (UTC)
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      topic:
        description: 'Specific topic slug (leave empty for next in queue)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (no file changes)'
        required: false
        default: false
        type: boolean

concurrency:
  group: content-generation
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  generate-blog-post:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Validate API key
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "::error::ANTHROPIC_API_KEY not set"
            exit 1
          fi
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - run: npm ci

      - name: Generate blog post
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            ARGS="--dry-run"
          fi
          if [ -n "${{ github.event.inputs.topic }}" ]; then
            ARGS="$ARGS --topic ${{ github.event.inputs.topic }}"
          fi
          npx tsx scripts/generate-blog-post.ts $ARGS

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Validate content integrity
        if: steps.changes.outputs.has_changes == 'true'
        run: npm run content:validate

      - name: Verify build
        if: steps.changes.outputs.has_changes == 'true'
        timeout-minutes: 10
        run: npm run build

      - name: Create Pull Request
        id: pr
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'content: add daily blog post'
          title: 'Daily Blog Post'
          body: |
            ## 자동 생성 블로그 포스트

            이 PR은 GitHub Actions에 의해 자동으로 생성되었습니다.
            빌드 검증 통과 후 자동 머지됩니다.
          branch: blog/daily-post
          labels: |
            blog
            auto-generated
          delete-branch: true

      - name: Auto-merge PR
        id: merge
        if: steps.pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh pr merge ${{ steps.pr.outputs.pull-request-number }} \
            --squash --delete-branch; then
            echo "merged=true" >> $GITHUB_OUTPUT
          else
            echo "::error::PR merge failed"
            echo "merged=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Post-merge deploy check
        if: steps.merge.outputs.merged == 'true'
        run: |
          echo "Waiting for Vercel deployment..."
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3: waiting 30s..."
            sleep 30
            STATUS=$(curl -o /dev/null -s -w "%{http_code}" --max-time 15 "https://fortunecookie.ai.kr" || echo "000")
            echo "Site status: $STATUS"
            if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
              echo "Deploy check passed"
              exit 0
            fi
            echo "Deploy check failed (HTTP $STATUS)"
          done
          echo "::error::Site still unhealthy after 3 attempts"
          exit 1

      - name: Check topic queue
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REMAINING=$(node -e "
            const fs = require('fs');
            const path = require('path');
            const topicsFile = path.join('scripts', 'blog-topics.ts');
            const usedFile = path.join('scripts', 'used-topics.json');
            const topicsContent = fs.readFileSync(topicsFile, 'utf-8');
            const slugMatches = topicsContent.match(/slug:\s*'([^']+)'/g) || [];
            const totalSlugs = slugMatches.length;
            let used = [];
            try { used = JSON.parse(fs.readFileSync(usedFile, 'utf-8')); } catch {}
            console.log(totalSlugs - used.length);
          ")
          echo "Remaining topics: $REMAINING"
          if [ "$REMAINING" -lt 10 ]; then
            echo "Topic queue low ($REMAINING). Triggering replenish..."
            gh workflow run replenish-topics.yml -f force=true
          fi

      - name: Notify failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Workflow Failure] Daily Blog Post - ${new Date().toISOString().split('T')[0]}`;
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure',
            });
            const existing = issues.find(i => i.title.includes('Daily Blog Post'));
            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body: `Workflow run failed: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                labels: ['workflow-failure'],
              });
            }

      - name: Auto-close failure issues on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure',
            });
            for (const issue of issues) {
              if (issue.title.includes('Daily Blog Post')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  state_reason: 'completed',
                });
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `✅ 파이프라인 복구됨.\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                });
              }
            }
